<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {
  font-family:'Inter',sans-serif;
  background:#fffdf8;
  color:#222;
  margin:0;
  padding:0;
  display:flex;
  flex-direction:column;
  align-items:center;
}
h1 {
  background:#d9b07e;
  color:#fff;
  width:100%;
  text-align:center;
  padding:20px 0;
  margin-bottom:10px;
}

/* Free plan notice */
.notice {
  background:#fff3e0;
  border-left:5px solid #d9b07e;
  color:#5c3b1e;
  padding:12px 16px;
  border-radius:6px;
  width:90%;
  max-width:500px;
  margin-bottom:20px;
  font-size:14px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}
.notice a {
  color:#c68642;
  font-weight:600;
  text-decoration:none;
}
.notice a:hover { text-decoration:underline; }

form {
  background:#fff;
  box-shadow:0 4px 15px rgba(0,0,0,0.08);
  border-radius:10px;
  padding:20px;
  max-width:400px;
  width:90%;
  display:flex;
  flex-direction:column;
  gap:12px;
}
input, textarea {
  width:100%;
  padding:10px;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:15px;
}
button {
  background:#d9b07e;
  border:none;
  color:white;
  font-weight:700;
  padding:10px 12px;
  border-radius:8px;
  cursor:pointer;
}
button:hover { background:#c69b6a; }

#tableContainer {
  width:90%;
  max-width:900px;
  margin-top:30px;
  overflow-x:auto;
}
table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  box-shadow:0 3px 10px rgba(0,0,0,0.05);
  border-radius:8px;
}
th, td {
  border-bottom:1px solid #eee;
  padding:10px;
  text-align:left;
  font-size:14px;
}
th {
  background:#f9f3eb;
  color:#5c3b1e;
}
td img {
  width:60px;
  border-radius:6px;
}
td button {
  margin-right:5px;
  font-size:13px;
  padding:5px 8px;
}
.editing input, .editing textarea {
  border:1px solid #c69b6a;
  background:#fffaf2;
}
</style>
</head>
<body>
  <h1>üõ†Ô∏è Jessy's World Admin</h1>

  <!-- Free Plan Notice -->
  <div class="notice">
    <b>Notice:</b> You are currently on the <strong>Free Plan</strong>.<br>
    You can only upload images up to <strong>1MB</strong>.<br>
    üëâ <a href="https://leading-edge-v-i.vercel.app/" target="_blank">View or change your plan here</a>.
  </div>

  <!-- Upload Form -->
  <form id="uploadForm">
    <input type="text" id="title" placeholder="Product Title" required>
    <input type="text" id="price" placeholder="Price (‚Ç¶)" required>
    <textarea id="description" placeholder="Description" required></textarea>
    <input type="file" id="imgFile" accept="image/*" required>
    <img id="preview" class="preview" style="display:none;max-width:100%;border-radius:6px;margin-top:8px;">
    <button type="submit">Upload Product</button>
  </form>

  <!-- Product Table -->
  <div id="tableContainer">
    <table>
      <thead>
        <tr>
          <th>Image</th>
          <th>Title</th>
          <th>Price (‚Ç¶)</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>
  </div>

<script>
const SUPABASE_URL = 'https://ccmsjcnuyrngqxwrswfe.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjbXNqY251eXJuZ3F4d3Jzd2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MjU2MjgsImV4cCI6MjA2NzIwMTYyOH0.dkjCo2bgDMf923VKESkyMLsULo7IhmsYb6r-4Dn6SRY';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const form = document.getElementById("uploadForm");
const imgFile = document.getElementById("imgFile");
const preview = document.getElementById("preview");
const productTable = document.getElementById("productTable");

// Show preview when selecting image
imgFile.addEventListener("change", (e)=>{
  const file = e.target.files[0];
  if(file){
    preview.src = URL.createObjectURL(file);
    preview.style.display = "block";
  }
});

// Upload new product
form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const title = document.getElementById("title").value.trim();
  const price = document.getElementById("price").value.trim();
  const description = document.getElementById("description").value.trim();
  const file = imgFile.files[0];

  if(!file){ alert("Please select an image."); return; }

  // Free plan size check
  if(file.size > 1 * 1024 * 1024){
    alert("‚ùå Image too large! Upload below 1MB or upgrade plan.");
    return;
  }

  const fileName = Date.now() + "_" + file.name.replace(/\s/g, "_");
  const { data: imgData, error: imgError } = await supabase.storage.from("product-images").upload(fileName, file);
  if(imgError){ alert("‚ùå Upload failed: " + imgError.message); return; }

  const { data: publicUrl } = supabase.storage.from("product-images").getPublicUrl(fileName);
  const img_url = publicUrl.publicUrl;

  const { error } = await supabase.from("products").insert([{ title, price, description, img_url }]);
  if(error){ alert("‚ùå Upload failed: " + error.message); }
  else {
    alert("‚úÖ Product uploaded!");
    form.reset();
    preview.style.display="none";
    fetchProducts();
  }
});

// Fetch and display products
async function fetchProducts(){
  const { data, error } = await supabase.from("products").select("*").order("id",{ascending:false});
  if(error){ console.error(error); return; }
  renderTable(data);
}
fetchProducts();

// Render product table
function renderTable(products){
  productTable.innerHTML = products.map(p => `
    <tr data-id="${p.id}">
      <td><img src="${p.img_url}" alt="${p.title}"></td>
      <td><input type="text" value="${p.title}" disabled></td>
      <td><input type="text" value="${p.price}" disabled></td>
      <td><textarea disabled>${p.description}</textarea></td>
      <td>
        <button class="editBtn">Edit</button>
        <button class="saveBtn" style="display:none;">Save</button>
        <button class="deleteBtn" style="background:#c55;">Delete</button>
      </td>
    </tr>
  `).join("");

  // Add functionality
  document.querySelectorAll(".editBtn").forEach(btn=>{
    btn.onclick = (e)=>{
      const row = e.target.closest("tr");
      row.classList.add("editing");
      row.querySelectorAll("input,textarea").forEach(f=>f.disabled=false);
      row.querySelector(".saveBtn").style.display="inline-block";
      e.target.style.display="none";
    };
  });

  document.querySelectorAll(".saveBtn").forEach(btn=>{
    btn.onclick = async (e)=>{
      const row = e.target.closest("tr");
      const id = row.dataset.id;
      const title = row.querySelector("input[type='text']").value;
      const price = row.querySelectorAll("input[type='text']")[1].value;
      const description = row.querySelector("textarea").value;

      const { error } = await supabase.from("products").update({ title, price, description }).eq("id", id);
      if(error){ alert("‚ùå Update failed: " + error.message); return; }
      alert("‚úÖ Product updated!");
      row.classList.remove("editing");
      row.querySelectorAll("input,textarea").forEach(f=>f.disabled=true);
      row.querySelector(".editBtn").style.display="inline-block";
      e.target.style.display="none";
    };
  });

  document.querySelectorAll(".deleteBtn").forEach(btn=>{
    btn.onclick = async (e)=>{
      if(!confirm("üóëÔ∏è Delete this product?")) return;
      const id = e.target.closest("tr").dataset.id;
      const { error } = await supabase.from("products").delete().eq("id", id);
      if(error){ alert("‚ùå Delete failed: " + error.message); return; }
      alert("‚úÖ Product deleted!");
      fetchProducts();
    };
  });
}
</script>
</body>
</html>
